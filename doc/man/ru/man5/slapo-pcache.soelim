.\" $ReOpenLDAP$
.\" Copyright 1992-2018 ReOpenLDAP AUTHORS: please see AUTHORS file.
.\" All rights reserved.
.\"
.\" This file is part of ReOpenLDAP.
.\"
.\" Redistribution and use in source and binary forms, with or without
.\" modification, are permitted only as authorized by the OpenLDAP
.\" Public License.
.\"
.\" A copy of this license is available in the file LICENSE in the
.\" top-level directory of the distribution or, alternatively, at
.\" <http://www.OpenLDAP.org/license.html>.

.TH SLAPO-PCACHE 5 "@RELEASE_DATE@" "ReOpenLDAP @VERSION@"

.SH НАЗВАНИЕ
slapo\-pcache \- наложение кэширующего прокси-сервера для slapd

.SH ОБЗОР
@SYSCONFDIR@/slapd.conf

.SH ОПИСАНИЕ
Наложение
.BR slapd (8)
.B pcache
позволяет кэшировать поисковые запросы LDAP в локальной базе данных. При обработке входящего запроса
кэширующий прокси определяет соответствующий ему \fBшаблон\fP. Если этот шаблон указан как
предназначенный для кэширования с помощью директивы \fBpcacheTemplate\fP и поступивший запрос содержится
в закэшированных запросах, ответ на него возвращается из кэша проски-сервера. В противном случае поиск
выполняется стандартным образом, а предназначенные для кэширования результаты сохраняются в кэш для
использования при обработке будущих запросов.
.LP

Шаблон определяется путём указания строки фильтра, а также индекса, идентифицирующего набор атрибутов.
\fBСтрока шаблона\fP для запроса может быть получена путём удаления значений утверждения из
представленного в формате RFC 4515 поискового фильтра этого запроса. Запрос считается удовлетворяющим
шаблону, если его \fBстрока шаблона\fP и набор предполагаемых для получения атрибутов соответствуют
предназначенному для кэширования шаблону. Примеры строки шаблона: \fB(mail=)\fP, \fB(|(sn=)(cn=))\fP,
\fB(&(sn=)(givenName=))\fP.

.LP
Директивы конфигурации, специфичные для наложения
.BR pcache ,
могут иметь префикс
.BR pcache\- ,
во избежание конфликтов с директивами базы данных, к которой применяется это наложение, либо с другими
наложениями, применяемыми к той же базе данных. Это может быть особенно полезно для директив,
относящихся к механизму манипуляции данными, используемому для локального хранилища. Для настройки
кэширующего прокси-сервера могут использоваться следующие относящиеся к кэшированию директивы:
.TP
.B overlay pcache
Данная директива добавляет наложение кэширующего прокси к текущей базе данных механизма манипуляции
данными. Наложение кэширующего прокси может использоваться с любым механизмом манипуляции данными,
однако предназначено для использования с механизмами
.BR ldap ,
.BR meta ,
и
.BR sql .
Обратите внимание, что в базе данных, к которой применяется это наложение, должна быть настроена директива
.BR rootdn.
.TP
.B pcache <database> <max_entries> <numattrsets> <entry_limit> <cc_period>
Эта директива включает прокси-кэширование в текущей базе данных и задаёт основные параметры кэша.
Механизм манипуляции данными, указанный в параметре <database>, будет использоваться подспудно для
сохранения кэшированных записей. Выбранная база данных также должна быть настроена, как показано ниже.
Ротация записей в кэше начинается, когда размер кэша достигает количества записей <max_entries>, и
продолжается до тех пор, пока количество записей в кэше не станет меньше этого значения. Значение
<numattrsets> должно совпадать с количеством последующих директив \fBpcacheAttrset\fP. Запросы кэшируются,
только если они соответствуют шаблону запросов, подлежащих кэшированию (задаётся директивой
\fBpcacheTemplate\fP), и количество возвращаемых на этот запрос записей меньше, чем значение <entry_limit>.
Проверка целостности выполняется каждый раз по прошествии периода <cc_period> (задаётся в секундах).
В каждом цикле запросы с просроченным "временем жизни" (\fBTTL\fP) удаляются. Пример конфигурации кэша:
.LP
.RS
pcache \fBmdb 10000 1 50 100\fP
.RE

.TP
.B pcacheAttrset <index> <attrs...>
Используется для связывания набора атрибутов <attrs..> с индексом <index>. Каждый набор атрибутов связан
с целым числом от 0 до <numattrsets>\-1. Эти индексы используются директивой \fBpcacheTemplate\fP для
определения шаблонов запросов, подлежащих кэшированию. Набор атрибутов не может быть пустым. Набор
атрибутов может содержать специальные атрибуты "*" (все пользовательские атрибуты), "+" (все операционные
атрибуты) или оба этих шаблона атрибутов; в последнем случае указание любого другого атрибута будет
избыточным и для ясности их указывать не следует. Набор атрибутов может состоять из единственного
атрибута "1.1"; в этом случае в кэш помещается только факт наличия записи. Для атрибутов с префиксом
"undef:" не требуется их наличия в схеме данных каталога.

.TP
.B pcacheMaxQueries <queries>
Указывает максимальное количество запросов, которые можно кэшировать. Значение по умолчанию - 10000.

.TP
.B pcacheValidate { TRUE | FALSE }
Указывает, необходимо ли выполнять проверку того, что результаты предназначенного для кэширования
запроса могут впоследствии быть без ошибок возвращены из кэша DSA прокси-сервера. При включении этого
параметра записи, возвращаемые предназначенным для кэширования запросом, перед помещением к кэш
проверяются на предмет для обеспечения согласованности со схемой данных, известной DSA прокси-сервера.
В случае обнаружения несогласованности данный запрос не кэшируется. По умолчанию такая проверка отключена.

.TP
.B pcacheOffline { TRUE | FALSE }
Переводит кэш в автономный режим. В автономном режиме прекращается проверка согласованности кэша с
удалённым сервером и проверка истечения срока действия записей. Это позволяет использовать содержимое
кэша неопределённое количество времени, пока у прокси-сервера нет доступа по сети к удалённому DSA.
Значение по умолчанию - FALSE, то есть проверки согласованности и истечения срока действия записей выполняются.

.TP
.B pcachePersist { TRUE | FALSE }
Указывает, должны ли закэшированные запросы сохраняться при перезапуске кэширующего прокси для
обеспечения "горячего" запуска кэша. Повторно загружаются только запросы с неистекшим временем жизни.
Значение по умолчанию - FALSE.

.BR ПРЕДОСТЕРЕЖЕНИЕ:
Конечно же, конфигурация кэширующего прокси не должна меняться при перезапуске; наложение pcache не
выполняет никаких проверок целостности по этому поводу. Точнее говоря, данную опцию следует отключить,
если порядок или содержимое существующих директив
.B pcacheAttrset
и
.B pcacheTemplate
изменялись. Если же были добавлены новые наборы атрибутов и шаблоны, либо изменились другие настройки
наложения pcache, это не должно повлиять на данную настройку.

.TP
.B pcacheTemplate <template_string> <attrset_index> <ttl> [<negttl> [<limitttl> [<ttr>]]]
Определяет шаблон запроса, подлежащего кэшированию, а также "время жизни" <ttl> для
запросов, удовлетворяющих этому шаблону. Опциональное значение <negttl> может использоваться для
указания того, что запросы с негативными результатами (то есть в ответ на которые было возвращено
ноль записей) также следует кэшировать на указанное время. По умолчанию запросы с негативными
результатами не кэшируются (<negttl> установлено в 0). Опциональное значение <limitttl> может
использоваться для указания того, что запросы, в результате которых было превышено ограничение по
размеру, также следует кэшировать на указанное время. По умолчанию запросы с превышением ограничений
по размеру не кэшируются (<limitttl> установлено в 0). Опциональное значение <ttr> ("время перезагрузки")
может использоваться для указания того, что закэшированные записи следует автоматически перезагружать
по истечении определенного времени. Записи перезагружаются только в том случае, если они не просрочены,
то есть, чтобы данная настройка приносила пользу, значение <ttl> должно быть больше значения <ttr>.
По умолчанию записи в кэше не перезагружаются (<ttr> установлено в 0).

.TP
.B pcacheBind <filter_template> <attrset_index> <ttr> <scope> <base>
Определяет шаблон для кэширования удостоверяющих данных, используемых для выполнения простого подсоединения
(Simple Bind) на основе заранее определённого в директиве \fBpcacheTemplate\fP шаблона. Строка
<filter_template> аналогична строке <template_string>, за исключением того, что некоторые значения в
ней могут присутствовать. Предназначение этого параметра - позволить наложению сгенерировать фильтр
по аналогии с тем, который генерируют сторонние приложения при выполнении поиска, непосредственно
предшествующего операции Bind. Например, если клиентское приложение типа nss_ldap настроено на поиск
пользователя с фильтром "(&(objectClass=posixAccount)(uid=<username>))", то в параметре <filter_template>
следует использовать шаблон "(&(objectClass=posixAccount)(uid=))". При конвертации в стандартную строку
шаблона "(&(objectClass=)(uid=))", полученная строка, а также набор атрибутов с индексом <attrset_index>
должны совпасть с уже определённым в директиве \fBpcacheTemplate\fP условием. Значение "время перезагрузки"
<ttr> определяет интервал времени, по истечении которого закэшированные удостоверяющие данные могут
быть перезагружены. Первый запрос Bind, выполненный по прошествии этого времени, запустит попытку
перезагрузки. Если кэш находится в автономном режиме, перезагрузка не выполняется. Для удостоверяющих
данных Bind не предусмотрено отдельного параметра "время жизни", они считаются просроченными в
соответствии со значением <ttl> директивы \fBpcacheTemplate\fP. Значения <scope> и <base> должны
совпадать с диапазоном и базой поиска, используемыми клиентом, производящим аутентификацию. Закэшированные
удостоверяющие данные хранятся не в виде открытого текста, а хэшируются с использованием алгоритма по
умолчанию, применяемого для хэширования паролей. По умолчанию кэширование удостоверяющих данных Bind отключено.

.TP
.B pcachePosition { head | tail }
Указывает, должна ли функция обработки ответа данного наложения располагаться в конце (\fBtail\fP)
списка вызова таких функций (поведение по умолчанию), или в его начале (\fBhead\fP) (а точнее, там,
где она должна располагаться согласно последовательности помещения наложений в стек). Данная настройка
влияет на то, как наложение pcache взаимодействует с другими наложениями, поскольку наложение
кэширующего прокси должно выполняться как можно раньше (и, следовательно, присутствовать в настройках
как можно позже), чтобы иметь шанс вернуть закэшированные результаты. С другой стороны, при раннем
выполнении в обработке ответа, оно будет кэшировать записи, которые позже могут быть преобразованы
другими наложениями базы данных, и потому в первый раз такие записи будут возращены в состоянии
\fIпосле\fP преобразования, а после кэширования эти же записи будут возвращаться в состоянии \fIдо\fP
преобразования.

.TP
Существуют некоторые ограничения:

все числовые значения должны быть положительными числами;

значение
.B <entry_limit>
должно быть меньше или равным
.BR <max_entries> ;

с помощью директивы
.BR pcacheAttrset
ДОЛЖНО быть определено
.B <numattrsets>
наборов атрибутов;

на каждый набор атрибутов ДОЛЖНА указывать хотя бы одна директива
.BR pcacheTemplate ;

.LP
Следующие директивы добавляют шаблон со строкой фильтра \fB(&(sn=)(givenName=))\fP, атрибутами mail,
postaladdress, telephonenumber и TTL 1 час.
.LP
.RS
.nf
pcacheAttrset \fB0 mail postaladdress telephonenumber\fP
pcacheTemplate \fB(&(sn=)(givenName=)) 0 3600\fP
.fi
.RE

.LP
Также должны быть заданы директивы конфигурации базы данных, предназначенной для хранения
закэшированных записей, например:
.LP
.RS
.nf
directory /var/tmp/cache
cachesize 100
.fi
.RE
.LP
Могут быть использованы любые директивы, относящиеся к выбранному типу баз данных. Для обрабатываемых
запросов следует настроить соответствующие индексы. Кроме того, следует настроить индекс equality для
атрибута \fBpcacheQueryid\fP для упрощения удаления данных просроченных запросов.
.SH ОБРАТНАЯ СОВМЕСТИМОСТЬ
Директивы конфигурации были переименованы, и использование предыдущей формы имён не одобряется.
Старые имена всё ещё распознаются, но в будущих версиях это может быть прекращено.

.TP
.B proxycache
используйте pcache

.TP
.B proxyattrset
используйте pcacheAttrset

.TP
.B proxycachequeries
используйте pcacheMaxQueries

.TP
.B proxycheckcacheability
используйте pcacheValidate

.TP
.B proxysavequeries
используйте pcachePersist

.TP
.B proxytemplate
используйте pcacheTemplate

.TP
.B response-callback
используйте pcachePosition

.SH ПРЕДОСТЕРЕЖЕНИЯ
Закэшированные данные могут отличаться от данных на удалённом сервере, поскольку происходящие на
удалённом сервере обновления не отражаются в ответах, возвращаемых из кэша, пока не истечёт
"время жизни" (\fBTTL\fP) запроса, указанное в директиве
.BR pcacheTemplate .
Такие несоответствия могут быть минимизированы путём тщательного подбора TTR.

Удалённый сервер должен предоставлять атрибут
.BR objectClass ,
поскольку он может понадобиться в базе данных, хранящей закэшированные записи, для оптимальной
локальной обработки этих записей.

На прокси-сервере в полном объёме должна поддерживаться схема данных каталога, требуемая для обработки
кэшируемых записей. В большей степени это относится к определению в схеме данных тех типов атрибутов,
которые используются в шаблонах запросов. Если в шаблоне запроса используется атрибут objectClass, в
схеме данных прокси-сервера требуется наличие определения объектных классов тех записей, которые,
предположительно, попадут в кэш. Ответственность за приведение схемы данных прокси-сервера в
соответствие со схемой данных удалённого сервера лежит на администраторе прокси-сервера.

Ещё одно потенциальное (и тонкое) несоответствие может возникнуть, когда данные извлекаются с
удалённого сервера от имени разных идентификационных сущностей и на удалённом сервере настроен
специфичный для разных идентификационных сущностей контроль доступа. Если данные были излечены от имени
идентификационной сущности, для которой правилами доступа на удалённом сервере разрешено получение лишь
частичных результатов, другие пользователи, привилегии доступа которых на удалённом сервере отличаются,
получат разные результаты при прямом обращении к удалённому серверу и из кэша. Если у этих пользователей
на удалённом сервере более высокие привилегии, то из кэша они получат лишь подмножество тех результатов,
которые могли бы получить с удалённого сервера. Если же их привилегии ниже, они получат из кэша больше
того, что могли бы получить непосредственно с удалённого сервера. И то и другое может быть как приемлемым,
так и неприемлемым, в зависимости от политик безопасности кэша и удалённого сервера. Важно понимать,
что в этом случае прокси-сервер нарушает политику безопасности удалённого сервера за счёт раскрытия
одной идентификационной сущности данных, собранных другой идентификационной сущностью. По этой причине,
при совместном использовании кэширующего прокси сервера с механизмом
.BR back-ldap ,
предлагается для кэширования использовать функционал
.I утверждения идентификационной сущности (identity assertion)
.BR slapd\-ldap (5)
(смотрите описание настроек
.B idassert\-bind
и
.BR idassert\-authz ),
таким образом, чтобы опрос удалённого сервера происходил от имени фиктивной идентификационной сущности,
обладающей относительно высокими привилегиями доступа на \fBпоиск\fP (\fBsearch\fP) и \fBчтение\fP
(\fBread\fP), а "реальный" контроль доступа делегировался ACL прокси-сервера. Имейте ввиду, что поскольку
кэширующему прокси доступна только закэшированная часть реальных данных, может оказаться невозможным
установить в точности те же правила доступа, что и на удалённом сервере. Когда обеспечение безопасности
каталога имеет важное значение, правила доступа для кэширующего прокси-сервера должны быть тщательно
спроектированы.
.SH ФАЙЛЫ
.TP
@SYSCONFDIR@/slapd.conf
конфигурационный файл slapd по умолчанию.
.SH СМОТРИТЕ ТАКЖЕ
.BR slapd.conf (5),
.BR slapd\-config (5),
.BR slapd\-ldap (5),
.BR slapd\-meta (5),
.BR slapd\-sql (5),
.BR slapd (8).
.SH АВТОРЫ
Первоначально реализовано Apurva Kumar как расширение механизма back-meta;
преобразовано в наложение Howard Chu.
